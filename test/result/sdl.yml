---
version: "2.0"
services:
  custom-comfy:
    image: ubuntu:22.04
    env:
      - 'SSH_PUBKEY=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCCeT7RpcTpn3hJE2HTC4r/lJh4xK0TVTcB4FqLNV7zDkG9PCr/RjpSCmEE1+KGH7BdF3Be+XbIGtdvFyKofjipc1ts872H1H/D65me5KpW1Pu9EW3m91uz8rkg6tl0g9IS19EjdGkB8BxwWdMTt1RtXqldd4ciAcKU5oUPaDpXO50CAn52wUtNaKaN0aUrLJ/Ls1PH1YWEe+B1AmG+Y2VK48GdMgHXImcqg51BTvnReRyWPleDRkSFvyPZUsm50Lf92f+9pZJw/tZv1DHLfM2rbGrfVCW1BBPiWGOSD0LKvA4Kc66ncaxRtGiCUPcRPIhP2uWXt77TldasgtaByfDd'
    command:
      - "bash"
      - "-c"
    args:
      - |
        apt-get update
        apt-get install -y wget curl --no-install-recommends curl git python3 python3-pip python3-dev build-essential
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        curl -fsSL https://developer.download.nvidia.com/compute/cuda/12.1.0/local_installers/cuda-repo-ubuntu2204-12-1-local_12.1.0-1_amd64.deb -O
        dpkg -i cuda-repo-ubuntu2204-12-1-local_12.1.0-1_amd64.deb
        apt-key add /var/cuda-repo-ubuntu2204-12-1-local/7fa2af80.pub
        apt-get update
        apt-get -y install cuda
        pip3 install torch==2.3.0 torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121
    expose:
      - port: 22
        as: 22
        to:
          - global: true 
      - port: 80
        as: 80
        to:
          - global: true 
profiles:
  compute:
    custom-comfy:
      resources:
        cpu:
          units: 2
        memory:
          size: 60GB
        storage:
          - size: 1Gi
        gpu:
          units: 1
          attributes:
            vendor:
              nvidia:
                - model: rtxa6000
                  ram: 48Gi
                  interface: pcie
  placement:
    dcloud:
      pricing:
        custom-comfy:
          denom: uakt
          amount: 1000
deployment:
  custom-comfy:
    dcloud:
      profile: custom-comfy
      count: 1
